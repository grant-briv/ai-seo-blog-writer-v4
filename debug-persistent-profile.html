<!DOCTYPE html>
<html>
<head>
    <title>Debug Persistent Profile</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
        button { padding: 10px 20px; margin: 10px 5px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #2563eb; }
        button.danger { background: #dc2626; }
        button.danger:hover { background: #b91c1c; }
        .success { color: green; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; max-height: 400px; overflow-y: auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
    </style>
</head>
<body>
    <h1>üïµÔ∏è Debug Persistent Profile Issue</h1>
    
    <div class="section">
        <h2>Step 1: Check All Storage Locations</h2>
        <button onclick="checkAllStorage()">Scan All Storage</button>
        <div id="storageResult"></div>
    </div>
    
    <div class="section">
        <h2>Step 2: Inspect IndexedDB Directly</h2>
        <button onclick="inspectIndexedDB()">Inspect IndexedDB</button>
        <div id="indexedDBResult"></div>
    </div>
    
    <div class="section">
        <h2>Step 3: Delete from All Locations</h2>
        <button onclick="deleteFromAllLocations()" class="danger">Delete "Brivity (Copy)" Everywhere</button>
        <div id="deleteResult"></div>
    </div>
    
    <div class="section">
        <h2>Step 4: Watch for Recreation</h2>
        <button onclick="startWatching()">Start Monitoring</button>
        <button onclick="stopWatching()">Stop Monitoring</button>
        <div id="watchResult"></div>
    </div>

    <script>
        let watchInterval = null;
        
        async function checkAllStorage() {
            const result = document.getElementById('storageResult');
            result.innerHTML = '<div>Checking all storage locations...</div>';
            
            try {
                // Check localStorage
                const localProfiles = JSON.parse(localStorage.getItem('aiWriterProfiles') || '[]');
                const brivityInLocal = localProfiles.filter(p => p.agentName === 'Brivity (Copy)');
                
                // Check sessionStorage
                const sessionProfiles = JSON.parse(sessionStorage.getItem('aiWriterProfiles') || '[]');
                const brivityInSession = sessionProfiles.filter(p => p.agentName === 'Brivity (Copy)');
                
                // Check IndexedDB
                const indexedDBResult = await checkIndexedDB();
                
                result.innerHTML = \`
                    <div class="section">
                        <h3>localStorage</h3>
                        <div>Total profiles: \${localProfiles.length}</div>
                        <div class="\${brivityInLocal.length > 0 ? 'error' : 'success'}">
                            "Brivity (Copy)" found: \${brivityInLocal.length}
                        </div>
                        \${brivityInLocal.length > 0 ? \`<pre>\${JSON.stringify(brivityInLocal, null, 2)}</pre>\` : ''}
                    </div>
                    
                    <div class="section">
                        <h3>sessionStorage</h3>
                        <div>Total profiles: \${sessionProfiles.length}</div>
                        <div class="\${brivityInSession.length > 0 ? 'error' : 'success'}">
                            "Brivity (Copy)" found: \${brivityInSession.length}
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>IndexedDB</h3>
                        \${indexedDBResult}
                    </div>
                \`;
                
            } catch (error) {
                result.innerHTML = \`<div class="error">Error: \${error.message}</div>\`;
            }
        }
        
        async function checkIndexedDB() {
            return new Promise((resolve) => {
                const request = indexedDB.open('ai-seo-blog-writer');
                
                request.onsuccess = function(event) {
                    const db = event.target.result;
                    
                    if (!db.objectStoreNames.contains('writerProfiles')) {
                        resolve('<div class="warning">writerProfiles store not found</div>');
                        return;
                    }
                    
                    const transaction = db.transaction(['writerProfiles'], 'readonly');
                    const store = transaction.objectStore('writerProfiles');
                    const getAllRequest = store.getAll();
                    
                    getAllRequest.onsuccess = function() {
                        const profiles = getAllRequest.result;
                        const brivityProfiles = profiles.filter(p => p.agentName === 'Brivity (Copy)');
                        
                        resolve(\`
                            <div>Total profiles: \${profiles.length}</div>
                            <div class="\${brivityProfiles.length > 0 ? 'error' : 'success'}">
                                "Brivity (Copy)" found: \${brivityProfiles.length}
                            </div>
                            \${brivityProfiles.length > 0 ? \`
                                <div class="warning">Found problematic profiles:</div>
                                <pre>\${JSON.stringify(brivityProfiles, null, 2)}</pre>
                            \` : ''}
                            <div class="section">
                                <strong>All profiles:</strong>
                                <pre>\${JSON.stringify(profiles.map(p => ({id: p.id, name: p.agentName})), null, 2)}</pre>
                            </div>
                        \`);
                    };
                    
                    getAllRequest.onerror = function() {
                        resolve('<div class="error">Error reading IndexedDB</div>');
                    };
                };
                
                request.onerror = function() {
                    resolve('<div class="error">Error opening IndexedDB</div>');
                };
            });
        }
        
        async function inspectIndexedDB() {
            const result = document.getElementById('indexedDBResult');
            result.innerHTML = await checkIndexedDB();
        }
        
        async function deleteFromAllLocations() {
            const result = document.getElementById('deleteResult');
            result.innerHTML = '<div>Deleting from all locations...</div>';
            
            let deletionResults = [];
            
            try {
                // Delete from localStorage
                let localProfiles = JSON.parse(localStorage.getItem('aiWriterProfiles') || '[]');
                const localCountBefore = localProfiles.length;
                localProfiles = localProfiles.filter(p => p.agentName !== 'Brivity (Copy)');
                localStorage.setItem('aiWriterProfiles', JSON.stringify(localProfiles));
                deletionResults.push(\`localStorage: \${localCountBefore - localProfiles.length} deleted\`);
                
                // Delete from sessionStorage
                let sessionProfiles = JSON.parse(sessionStorage.getItem('aiWriterProfiles') || '[]');
                const sessionCountBefore = sessionProfiles.length;
                sessionProfiles = sessionProfiles.filter(p => p.agentName !== 'Brivity (Copy)');
                sessionStorage.setItem('aiWriterProfiles', JSON.stringify(sessionProfiles));
                deletionResults.push(\`sessionStorage: \${sessionCountBefore - sessionProfiles.length} deleted\`);
                
                // Delete from IndexedDB
                const indexedDBDeletion = await deleteFromIndexedDB();
                deletionResults.push(\`IndexedDB: \${indexedDBDeletion}\`);
                
                result.innerHTML = \`
                    <div class="success">Deletion completed:</div>
                    <ul>
                        \${deletionResults.map(r => \`<li>\${r}</li>\`).join('')}
                    </ul>
                    <div class="warning">Now refresh localhost:5173 to see if it comes back</div>
                \`;
                
            } catch (error) {
                result.innerHTML = \`<div class="error">Error during deletion: \${error.message}</div>\`;
            }
        }
        
        async function deleteFromIndexedDB() {
            return new Promise((resolve) => {
                const request = indexedDB.open('ai-seo-blog-writer');
                
                request.onsuccess = function(event) {
                    const db = event.target.result;
                    
                    if (!db.objectStoreNames.contains('writerProfiles')) {
                        resolve('writerProfiles store not found');
                        return;
                    }
                    
                    const transaction = db.transaction(['writerProfiles'], 'readwrite');
                    const store = transaction.objectStore('writerProfiles');
                    
                    // First get all profiles to find the ones to delete
                    const getAllRequest = store.getAll();
                    
                    getAllRequest.onsuccess = function() {
                        const profiles = getAllRequest.result;
                        const toDelete = profiles.filter(p => p.agentName === 'Brivity (Copy)');
                        
                        if (toDelete.length === 0) {
                            resolve('0 profiles found to delete');
                            return;
                        }
                        
                        let deleteCount = 0;
                        let completed = 0;
                        
                        toDelete.forEach(profile => {
                            const deleteRequest = store.delete(profile.id);
                            
                            deleteRequest.onsuccess = function() {
                                deleteCount++;
                                completed++;
                                if (completed === toDelete.length) {
                                    resolve(\`\${deleteCount} profiles deleted\`);
                                }
                            };
                            
                            deleteRequest.onerror = function() {
                                completed++;
                                if (completed === toDelete.length) {
                                    resolve(\`\${deleteCount} profiles deleted (some errors)\`);
                                }
                            };
                        });
                    };
                };
                
                request.onerror = function() {
                    resolve('Error opening IndexedDB');
                };
            });
        }
        
        function startWatching() {
            const result = document.getElementById('watchResult');
            result.innerHTML = '<div class="warning">Monitoring for profile recreation...</div>';
            
            watchInterval = setInterval(async () => {
                const localProfiles = JSON.parse(localStorage.getItem('aiWriterProfiles') || '[]');
                const brivityInLocal = localProfiles.filter(p => p.agentName === 'Brivity (Copy)');
                
                const indexedDBCheck = await checkIndexedDB();
                const hasBrivityInIndexedDB = indexedDBCheck.includes('"Brivity (Copy)" found: 1') || 
                                             indexedDBCheck.includes('"Brivity (Copy)" found: 2');
                
                if (brivityInLocal.length > 0 || hasBrivityInIndexedDB) {
                    result.innerHTML += \`
                        <div class="error">üö® Profile detected at \${new Date().toLocaleTimeString()}</div>
                        <div>localStorage: \${brivityInLocal.length}, IndexedDB: \${hasBrivityInIndexedDB ? 'YES' : 'NO'}</div>
                    \`;
                }
            }, 2000);
        }
        
        function stopWatching() {
            if (watchInterval) {
                clearInterval(watchInterval);
                watchInterval = null;
                const result = document.getElementById('watchResult');
                result.innerHTML += '<div class="success">Monitoring stopped</div>';
            }
        }
    </script>
</body>
</html>