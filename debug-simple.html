<!DOCTYPE html>
<html>
<head>
    <title>Debug Persistent Profile</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; }
        button { padding: 10px 20px; margin: 10px 5px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #2563eb; }
        button.danger { background: #dc2626; }
        button.danger:hover { background: #b91c1c; }
        .success { color: green; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; max-height: 300px; overflow-y: auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
    </style>
</head>
<body>
    <h1>Debug Persistent Profile Issue</h1>
    
    <div class="section">
        <h2>Check localStorage</h2>
        <button onclick="checkLocalStorage()">Check localStorage</button>
        <div id="localResult"></div>
    </div>
    
    <div class="section">
        <h2>Check IndexedDB</h2>
        <button onclick="checkIndexedDB()">Check IndexedDB</button>
        <div id="indexedResult"></div>
    </div>
    
    <div class="section">
        <h2>Delete from Both</h2>
        <button onclick="deleteEverywhere()" class="danger">Delete "Brivity (Copy)" from All Storage</button>
        <div id="deleteResult"></div>
    </div>

    <script>
        function checkLocalStorage() {
            const result = document.getElementById('localResult');
            try {
                const profiles = JSON.parse(localStorage.getItem('aiWriterProfiles') || '[]');
                const brivityProfiles = profiles.filter(p => p.agentName === 'Brivity (Copy)');
                
                result.innerHTML = 
                    '<div>Total profiles in localStorage: ' + profiles.length + '</div>' +
                    '<div class="' + (brivityProfiles.length > 0 ? 'error' : 'success') + '">' +
                    'Brivity (Copy) found: ' + brivityProfiles.length + '</div>' +
                    '<pre>' + JSON.stringify(profiles.map(p => ({id: p.id, name: p.agentName})), null, 2) + '</pre>';
                    
            } catch (error) {
                result.innerHTML = '<div class="error">Error: ' + error.message + '</div>';
            }
        }
        
        function checkIndexedDB() {
            const result = document.getElementById('indexedResult');
            result.innerHTML = '<div>Checking IndexedDB...</div>';
            
            const request = indexedDB.open('ai-seo-blog-writer');
            
            request.onsuccess = function(event) {
                const db = event.target.result;
                
                if (!db.objectStoreNames.contains('writerProfiles')) {
                    result.innerHTML = '<div class="warning">writerProfiles store not found</div>';
                    return;
                }
                
                const transaction = db.transaction(['writerProfiles'], 'readonly');
                const store = transaction.objectStore('writerProfiles');
                const getAllRequest = store.getAll();
                
                getAllRequest.onsuccess = function() {
                    const profiles = getAllRequest.result;
                    const brivityProfiles = profiles.filter(p => p.agentName === 'Brivity (Copy)');
                    
                    result.innerHTML = 
                        '<div>Total profiles in IndexedDB: ' + profiles.length + '</div>' +
                        '<div class="' + (brivityProfiles.length > 0 ? 'error' : 'success') + '">' +
                        'Brivity (Copy) found: ' + brivityProfiles.length + '</div>' +
                        '<pre>' + JSON.stringify(profiles.map(p => ({id: p.id, name: p.agentName})), null, 2) + '</pre>';
                        
                    if (brivityProfiles.length > 0) {
                        result.innerHTML += '<div class="error">Problematic profile data:</div>' +
                            '<pre>' + JSON.stringify(brivityProfiles, null, 2) + '</pre>';
                    }
                };
                
                getAllRequest.onerror = function() {
                    result.innerHTML = '<div class="error">Error reading IndexedDB</div>';
                };
            };
            
            request.onerror = function() {
                result.innerHTML = '<div class="error">Error opening IndexedDB</div>';
            };
        }
        
        function deleteEverywhere() {
            const result = document.getElementById('deleteResult');
            result.innerHTML = '<div>Deleting from all locations...</div>';
            
            let deletionLog = [];
            
            // Delete from localStorage
            try {
                let profiles = JSON.parse(localStorage.getItem('aiWriterProfiles') || '[]');
                const beforeCount = profiles.length;
                const brivityBefore = profiles.filter(p => p.agentName === 'Brivity (Copy)').length;
                
                profiles = profiles.filter(p => p.agentName !== 'Brivity (Copy)');
                localStorage.setItem('aiWriterProfiles', JSON.stringify(profiles));
                
                deletionLog.push('localStorage: ' + brivityBefore + ' profiles deleted');
            } catch (error) {
                deletionLog.push('localStorage error: ' + error.message);
            }
            
            // Delete from IndexedDB
            const request = indexedDB.open('ai-seo-blog-writer');
            
            request.onsuccess = function(event) {
                const db = event.target.result;
                
                if (!db.objectStoreNames.contains('writerProfiles')) {
                    deletionLog.push('IndexedDB: writerProfiles store not found');
                    showDeletionResult();
                    return;
                }
                
                const transaction = db.transaction(['writerProfiles'], 'readwrite');
                const store = transaction.objectStore('writerProfiles');
                
                // Get all profiles first
                const getAllRequest = store.getAll();
                
                getAllRequest.onsuccess = function() {
                    const profiles = getAllRequest.result;
                    const toDelete = profiles.filter(p => p.agentName === 'Brivity (Copy)');
                    
                    if (toDelete.length === 0) {
                        deletionLog.push('IndexedDB: 0 profiles found to delete');
                        showDeletionResult();
                        return;
                    }
                    
                    let deleteCount = 0;
                    let completed = 0;
                    
                    toDelete.forEach(profile => {
                        const deleteRequest = store.delete(profile.id);
                        
                        deleteRequest.onsuccess = function() {
                            deleteCount++;
                            completed++;
                            if (completed === toDelete.length) {
                                deletionLog.push('IndexedDB: ' + deleteCount + ' profiles deleted');
                                showDeletionResult();
                            }
                        };
                        
                        deleteRequest.onerror = function() {
                            completed++;
                            if (completed === toDelete.length) {
                                deletionLog.push('IndexedDB: ' + deleteCount + ' profiles deleted (with errors)');
                                showDeletionResult();
                            }
                        };
                    });
                };
            };
            
            request.onerror = function() {
                deletionLog.push('IndexedDB: Error opening database');
                showDeletionResult();
            };
            
            function showDeletionResult() {
                result.innerHTML = 
                    '<div class="success">Deletion completed:</div>' +
                    '<ul>' + deletionLog.map(log => '<li>' + log + '</li>').join('') + '</ul>' +
                    '<div class="warning">Now refresh localhost:5173 to test</div>';
            }
        }
    </script>
</body>
</html>