<!DOCTYPE html>
<html>
<head>
    <title>Cleanup Database</title>
    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
</head>
<body>
    <h1>Database Cleanup</h1>
    <div id="results"></div>
    <div style="margin-top: 20px;">
        <button onclick="cleanupDuplicates()" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 5px; margin: 5px;">Remove Duplicate/Broken Users</button>
        <button onclick="checkUsers()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; margin: 5px;">Check Current Users</button>
    </div>
    
    <script>
        const db = new Dexie('AiSEOBlogWriterDB');
        db.version(1).stores({
            users: 'id, username, role',
            writerProfiles: 'id, ownerId, agentName',
            savedBlogPosts: 'id, userId, blogTitle, savedAt',
            topicSearches: '++id, userId, searchQuery, createdAt',
            appSettings: 'key'
        });

        async function checkUsers() {
            try {
                await db.open();
                const users = await db.users.toArray();
                
                document.getElementById('results').innerHTML = `
                    <h2>Current Users (${users.length})</h2>
                    ${users.map(user => `
                        <div style="border: 1px solid #ccc; margin: 10px 0; padding: 15px;">
                            <strong>${user.username}</strong> (${user.role})<br>
                            ID: ${user.id}<br>
                            Email: ${user.email || 'None'}<br>
                            Has Password: ${user.password ? 'Yes ✅' : 'No ❌'}<br>
                            ${user.password ? `Password Length: ${user.password.length}<br>Is Hashed: ${user.password.startsWith('$2') ? 'Yes ✅' : 'No ❌'}` : ''}
                        </div>
                    `).join('')}
                `;
                
            } catch (error) {
                document.getElementById('results').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }

        async function cleanupDuplicates() {
            try {
                await db.open();
                const users = await db.users.toArray();
                
                // Group users by username
                const userGroups = {};
                users.forEach(user => {
                    if (!userGroups[user.username]) {
                        userGroups[user.username] = [];
                    }
                    userGroups[user.username].push(user);
                });
                
                let deletedCount = 0;
                let fixedCount = 0;
                
                for (const [username, userList] of Object.entries(userGroups)) {
                    if (userList.length > 1) {
                        console.log(`Found ${userList.length} users with username: ${username}`);
                        
                        // Keep the user with a valid password, delete others
                        const validUser = userList.find(u => u.password && u.password.startsWith('$2'));
                        const invalidUsers = userList.filter(u => u !== validUser);
                        
                        for (const invalidUser of invalidUsers) {
                            console.log(`Deleting invalid user: ${invalidUser.id}`);
                            await db.users.delete(invalidUser.id);
                            deletedCount++;
                        }
                        
                        if (validUser) {
                            fixedCount++;
                            console.log(`Kept valid user: ${validUser.id}`);
                        }
                    } else if (userList.length === 1) {
                        // Single user - check if password is missing
                        const user = userList[0];
                        if (!user.password && user.username !== 'admin') {
                            console.log(`Deleting user with no password: ${user.username}`);
                            await db.users.delete(user.id);
                            deletedCount++;
                        }
                    }
                }
                
                alert(`Cleanup completed!\\nDeleted: ${deletedCount} users\\nFixed: ${fixedCount} users`);
                await checkUsers();
                
            } catch (error) {
                alert('Cleanup failed: ' + error.message);
            }
        }

        // Check users on load
        checkUsers();
    </script>
</body>
</html>